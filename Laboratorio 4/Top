`timescale 1ns / 1ps

module Top#(
    parameter int XLEN = 64)(
    input clk, reset,
    output logic [3:0] st_dbg
    );
    
    logic [6:0]         opcode;
    logic [2:0]         funct3;
    logic [6:0]         funct7;
    logic               Zero;
    logic               PCWriteCond, PCWrite ;
    logic [1:0]         PCSource;
    logic               IorD;
    logic               MemRead;
    logic               MemWrite;
    logic [1:0]         MemtoReg;           //escoge el valor a escribir en registro
    logic               IRWrite;
    logic               RegWrite;
    logic [3:0]         ALUOp;  
    logic [1:0]         ALUSrcB;
    logic [1:0]         ALUSrcA;
    logic [2:0]         ImmSel;
    logic [XLEN-1:0]    mem_addr;
    logic [XLEN-1:0]    PC_ir;
    logic [XLEN-1:0]    mem_rdata;
    logic [XLEN-1:0]    mem_wdata;
    logic [63:0]        pc_addr;
    logic [31:0]        instr;
    logic               instr_valid;
    logic [63:0]        d_addr;
    logic [63:0]        d_wdata;
    logic [63:0]        rdata;
    logic               d_valid;
    logic               LatchAB; 
    logic               ALUOutEn;
    
//Control      
    control_global 
        uA (   
            .clk        (clk), 
            .reset      (reset), 
            .opcode     (opcode), 
            .funct3     (funct3), 
            .funct7     (funct7), 
            .PCWriteCond(PCWriteCond), 
            .PCWrite    (PCWrite), 
            .PCSource   (PCSource), 
            .st_dbg     (st_dbg),
            .IorD       (IorD), 
            .MemRead    (MemRead), 
            .MemWrite   (MemWrite), 
            .MemtoReg   (MemtoReg),     //escoge el valor a escribir en registro
            .IRWrite    (IRWrite), 
            .RegWrite   (RegWrite), 
            .d_valid    (d_valid),
            .Zero       (Zero), 
            .ALUOp      (ALUOp),        //pulso de seleccion para el valor de operacion en la ALU
            .ALUSrcA    (ALUSrcA),      //pulso de selecci n de d nde proviene el valor de A
            .ALUSrcB    (ALUSrcB),      //pulso de seleccion de donde proviene el valor de B
            .ImmSel     (ImmSel),       
            .instr_valid(instr_valid), 
            .LatchAB    (LatchAB), 
            .ALUOutEn   (ALUOutEn)
            );

//Datapath
    datapath #(.XLEN(64)) 
        DP (
            .clk        (clk), 
            .reset      (reset), 
            .opcode     (opcode), 
            .funct3     (funct3), 
            .funct7     (funct7), 
            .PCWriteCond(PCWriteCond), 
            .PCWrite    (PCWrite), 
            .PCSource   (PCSource), 
            .PC_ir      (PC_ir),
            .IorD       (IorD), 
            .MemRead    (MemRead), 
            .MemWrite   (MemWrite), 
            .MemtoReg   (MemtoReg),     //escoge el valor a escribir en registro
            .IRWrite    (IRWrite), 
            .RegWrite   (RegWrite), 
            .Zero       (Zero), 
            .ALUOp      (ALUOp),        //pulso de seleccion para el valor de operacion en la ALU
            .ALUSrcA    (ALUSrcA),      //pulso de selecci n de d nde proviene el valor de A
            .ALUSrcB    (ALUSrcB),      //pulso de seleccion de donde proviene el valor de B
            .LatchAB    (LatchAB), 
            .ALUOutEn   (ALUOutEn),
            .ImmSel     (ImmSel),
            .pc_addr    (pc_addr), 
            .instr      (instr), 
            .instr_valid(instr_valid),
            .d_addr     (d_addr), 
            .rdata      (rdata), 
            .d_wdata    (d_wdata), 
            .d_valid    (d_valid)
    );
    
 //Memoria de instrucciones   
    instr_mem 
        IMEM (
           .clk(clk), .reset(reset),
           .MemRead(MemRead & ~IorD),
           .mem_addr(pc_addr),
           .instr(instr),
           .instr_valid(instr_valid)
    );

  // RAM datos
    data_mem 
        DMEM(
          .clk(clk), .reset(reset),
          .MemRead (MemRead  &  IorD),
          .MemWrite(MemWrite &  IorD),
          .addr(d_addr),
          .wdata(d_wdata),
          .rdata(rdata),
          .valid(d_valid)
  );
  
endmodule
